// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Example models - customize based on your needs

model User {
  id           String   @id @default(cuid())
  email        String   @unique
  passwordHash String
  name         String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  favorites              Favorite[]
  refreshTokens          RefreshToken[]
  sentFriendRequests     Friendship[]    @relation("FriendshipRequester")
  receivedFriendRequests Friendship[]    @relation("FriendshipAddressee")
  ownedGroups            Group[]         @relation("GroupOwner")
  groupMemberships       GroupMember[]
  games                  Game[]
  gameSearches           GameSearch[]
}

enum FriendshipStatus {
  PENDING
  ACCEPTED
  REJECTED
  BLOCKED
}

model Friendship {
  id          String           @id @default(cuid())
  requesterId String
  addresseeId String
  status      FriendshipStatus @default(PENDING)
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt

  requester User @relation("FriendshipRequester", fields: [requesterId], references: [id], onDelete: Cascade)
  addressee User @relation("FriendshipAddressee", fields: [addresseeId], references: [id], onDelete: Cascade)

  @@unique([requesterId, addresseeId])
  @@index([requesterId])
  @@index([addresseeId])
  @@index([status])
}

model RefreshToken {
  id        String   @id @default(cuid())
  token     String   @unique
  userId    String
  expiresAt DateTime
  revoked   Boolean  @default(false)
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
}

model Location {
  id              String   @id @default(cuid())
  tripadvisorId   String   @unique
  name            String
  description     String?
  address         String?
  latitude        Float?
  longitude       Float?
  rating          Float?
  priceLevel      String?
  phone           String?
  website         String?
  imageUrl        String?
  category        String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  favorites Favorite[]
}

model Favorite {
  id         String   @id @default(cuid())
  userId     String
  locationId String
  createdAt  DateTime @default(now())

  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  location Location @relation(fields: [locationId], references: [id], onDelete: Cascade)

  @@unique([userId, locationId])
}

model Group {
  id          String   @id @default(cuid())
  name        String
  description String?
  ownerId     String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  owner   User          @relation("GroupOwner", fields: [ownerId], references: [id], onDelete: Cascade)
  members GroupMember[]
  games   Game[]

  @@index([ownerId])
}

enum GroupRole {
  OWNER
  ADMIN
  MEMBER
}

model GroupMember {
  id       String    @id @default(cuid())
  groupId  String
  userId   String
  role     GroupRole @default(MEMBER)
  joinedAt DateTime  @default(now())

  group Group @relation(fields: [groupId], references: [id], onDelete: Cascade)
  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([groupId, userId])
  @@index([groupId])
  @@index([userId])
}

enum GameStatus {
  ACTIVE
  COMPLETED
  CANCELLED
}

model Game {
  id        String     @id @default(cuid())
  ownerId   String
  groupId   String?
  status    GameStatus @default(ACTIVE)
  filters   Json?      // Store game filters (cuisine, priceRange, minRating, dietaryRestrictions)
  mapArea   Json?      // Store map area as GeoJSON
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt

  owner    User         @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  group    Group?       @relation(fields: [groupId], references: [id], onDelete: Cascade)
  searches GameSearch[]

  @@index([ownerId])
  @@index([groupId])
}

model GameSearch {
  id        String   @id @default(cuid())
  gameId    String
  userId    String
  query     String
  category  String?
  latLong   String?
  createdAt DateTime @default(now())

  game    Game               @relation(fields: [gameId], references: [id], onDelete: Cascade)
  user    User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  results GameSearchResult[]

  @@index([gameId])
  @@index([userId])
}

model GameSearchResult {
  id            String  @id @default(cuid())
  searchId      String
  tripadvisorId String
  name          String
  address       String?
  latitude      Float?
  longitude     Float?
  rating        Float?
  priceLevel    String?
  imageUrl      String?

  search GameSearch @relation(fields: [searchId], references: [id], onDelete: Cascade)

  @@index([searchId])
}

// ========== Observability & Metrics Tables ==========

model Event {
  id             String   @id @default(uuid())
  userId         String?  @map("user_id")
  sessionId      String   @map("session_id")
  eventType      String   @map("event_type")
  properties     Json?
  accountId      String?  @map("account_id")
  source         String   @default("native-app")
  createdAt      DateTime @default(now()) @map("created_at")
  ingestedAt     DateTime @default(now()) @map("ingested_at")
  idempotencyKey String?  @unique @map("idempotency_key")

  @@index([eventType, createdAt])
  @@index([userId, createdAt])
  @@index([sessionId])
  @@map("event")
}

model EventRollupDaily {
  eventDate     DateTime @map("event_date") @db.Date
  eventType     String   @map("event_type")
  count         BigInt
  uniqueUsers   BigInt?  @map("unique_users")
  propertiesAgg Json?    @map("properties_agg")

  @@id([eventDate, eventType])
  @@map("event_rollup_daily")
}

model CostExternal {
  id          String   @id @default(uuid())
  service     String
  unit        String
  quantity    Decimal  @db.Decimal(20, 6)
  unitCost    Decimal  @map("unit_cost") @db.Decimal(20, 6)
  periodStart DateTime @map("period_start") @db.Date
  periodEnd   DateTime @map("period_end") @db.Date
  notes       String?
  createdAt   DateTime @default(now()) @map("created_at")

  @@index([service, periodStart])
  @@map("cost_external")
}

model Revenue {
  id          String    @id @default(uuid())
  userId      String?   @map("user_id")
  source      String
  plan        String
  amountGross Decimal   @map("amount_gross") @db.Decimal(20, 6)
  fees        Decimal   @db.Decimal(20, 6)
  amountNet   Decimal   @map("amount_net") @db.Decimal(20, 6)
  periodStart DateTime? @map("period_start") @db.Date
  periodEnd   DateTime? @map("period_end") @db.Date
  externalRef String?   @map("external_ref")
  createdAt   DateTime  @default(now()) @map("created_at")

  @@index([userId])
  @@index([source, createdAt])
  @@map("revenue")
}

model MatchStats {
  id                    String    @id @default(uuid())
  matchId               String    @unique @map("match_id")
  mode                  String
  voteRule              String    @map("vote_rule")
  participants          Int
  cardsPresented        Int       @map("cards_presented")
  cardsLiked            Int       @map("cards_liked")
  timeToDecisionSeconds Int?      @map("time_to_decision_seconds")
  resultRestaurantId    String?   @map("result_restaurant_id")
  completed             Boolean   @default(false)
  createdAt             DateTime  @default(now()) @map("created_at")
  completedAt           DateTime? @map("completed_at")

  @@index([mode, createdAt])
  @@index([completed, createdAt])
  @@map("match_stats")
}

model AdImpression {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  placement String
  provider  String?
  watchedMs Int      @map("watched_ms")
  completed Boolean  @default(false)
  createdAt DateTime @default(now()) @map("created_at")

  @@index([userId, createdAt])
  @@index([placement, createdAt])
  @@map("ad_impression")
}

model ApiRequestLog {
  id            String   @id @default(uuid())
  route         String
  method        String
  status        Int
  latencyMs     Int      @map("latency_ms")
  requestSize   Int?     @map("request_size") // Request body size in bytes
  responseSize  Int?     @map("response_size") // Response body size in bytes
  userId        String?  @map("user_id")
  ipAddress     String?  @map("ip_address")
  userAgent     String?  @map("user_agent")
  createdAt     DateTime @default(now()) @map("created_at")

  @@index([route, createdAt])
  @@index([status, createdAt])
  @@index([latencyMs, createdAt]) // For performance bottleneck detection
  @@index([userId, createdAt])
  @@map("api_request_log")
}

model ErrorLog {
  id            String   @id @default(uuid())
  userId        String?  @map("user_id")
  sessionId     String?  @map("session_id")
  errorType     String   @map("error_type")
  errorMessage  String   @map("error_message")
  stackTrace    String?  @map("stack_trace") @db.Text
  context       Json?    // Additional context (request details, user agent, etc.)
  severity      String   @default("error") // error, warning, critical
  source        String   @default("server") // server, client, native-app, web
  route         String?  // API route if applicable
  method        String?  // HTTP method if applicable
  statusCode    Int?     @map("status_code") // HTTP status code if applicable
  userAgent     String?  @map("user_agent")
  ipAddress     String?  @map("ip_address")
  resolved      Boolean  @default(false)
  resolvedAt    DateTime? @map("resolved_at")
  resolvedBy    String?  @map("resolved_by")
  createdAt     DateTime @default(now()) @map("created_at")

  @@index([errorType, createdAt])
  @@index([userId, createdAt])
  @@index([severity, createdAt])
  @@index([resolved, createdAt])
  @@index([source, createdAt])
  @@map("error_log")
}

model DatabaseQueryLog {
  id            String   @id @default(uuid())
  query         String   @db.Text // SQL query (sanitized)
  params        Json?    // Query parameters (sanitized)
  executionTime Int      @map("execution_time") // Execution time in milliseconds
  model         String?  // Prisma model name (e.g., "User", "Game")
  operation     String?  // Prisma operation (e.g., "findMany", "create", "update")
  userId        String?  @map("user_id") // User context if available
  route         String?  // API route that triggered this query
  success       Boolean  @default(true)
  errorMessage  String?  @map("error_message")
  createdAt     DateTime @default(now()) @map("created_at")

  @@index([model, createdAt])
  @@index([operation, createdAt])
  @@index([executionTime, createdAt]) // For performance bottleneck detection
  @@index([userId, createdAt])
  @@index([route, createdAt])
  @@index([success, createdAt])
  @@map("database_query_log")
}

model PerformanceBottleneckLog {
  id            String   @id @default(uuid())
  type          String   // "slow_query", "slow_endpoint", "high_memory", "connection_pool_exhausted"
  severity      String   @default("warning") // "warning", "critical"
  threshold     Int      @map("threshold_ms") // Threshold in milliseconds
  actualValue   Int      @map("actual_value_ms") // Actual value in milliseconds
  resource      String?  // Resource identifier (endpoint route, query model, etc.)
  details       Json?    // Additional details (query, endpoint, stack trace, etc.)
  userId        String?  @map("user_id")
  resolved      Boolean  @default(false)
  resolvedAt    DateTime? @map("resolved_at")
  resolvedBy    String?  @map("resolved_by")
  createdAt     DateTime @default(now()) @map("created_at")

  @@index([type, createdAt])
  @@index([severity, createdAt])
  @@index([resource, createdAt])
  @@index([resolved, createdAt])
  @@map("performance_bottleneck_log")
}

